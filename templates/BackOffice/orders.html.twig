<!DOCTYPE html>
<html
  lang="fr"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="{{ asset('BackOffice/assets/') }}"
  data-template="vertical-menu-template-free"
>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>üõí Gestion des Commandes | Sneat Admin</title>
  <meta name="description" content="Gestion des commandes" />
  <link rel="icon" type="image/x-icon" href="{{ asset('BackOffice/assets/img/favicon/favicon.ico') }}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/vendor/fonts/boxicons.css') }}" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/vendor/css/core.css') }}" class="template-customizer-core-css" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/vendor/css/theme-default.css') }}" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/css/demo.css') }}" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css') }}" />
  <link rel="stylesheet" href="{{ asset('BackOffice/assets/vendor/libs/apex-charts/apex-charts.css') }}" />
  <script src="{{ asset('BackOffice/assets/vendor/js/helpers.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/js/config.js') }}"></script>
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->
      {% include 'BackOffice/partials/menu.html.twig' %}
      <!-- /Menu -->
      <div class="layout-page">
        <div class="content-wrapper bg-light min-vh-100">
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="container mt-5">
              <div class="card shadow-lg border-0 rounded-4 p-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
                  <h2 class="text-primary fw-bold mb-3 mb-md-0">
                    üõí Gestion des Commandes
                  </h2>
                  <a href="{{ path('orders_page') }}" class="btn btn-primary rounded-pill px-4">
                    <i class="bx bx-refresh"></i> Rafra√Æchir
                  </a>
                </div>
                {% for message in app.flashes('success') %}
                  <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                  </div>
                {% endfor %}
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                  <input type="text" id="searchInput" class="form-control w-100 w-md-50" placeholder="üîé Rechercher une commande...">
                </div>
                <div class="table-responsive">
                  <table class="table table-hover table-bordered align-middle bg-white rounded-3 overflow-hidden">
                    <thead class="table-primary text-center align-middle">
                      <tr>
                        <th>üÜî ID</th>
                        <th>üìÖ Date</th>
                        <th>üì¶ Statut</th>
                        <th>üõçÔ∏è Produit</th>
                        <th>üë§ Utilisateur</th>
                        <th>‚öôÔ∏è Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for order in pagination %}
                        <tr>
                          <td class="text-center">#{{ order.id }}</td>
                          <td>{{ order.date|date('Y-m-d H:i') }}</td>
                          <td class="text-center">
                            <span class="badge bg-{{ order.status == 'delivered' ? 'success' : 'warning' }}">
                              {{ order.status|capitalize }}
                            </span>
                          </td>
                          <td>{{ order.product.name }}</td>
                          <td>
                            {% if order.user is defined and order.user %}
                              {{ order.user.Name ~ ' (ID: ' ~ order.user.id ~ ')' }}
                            {% else %}
                              <span class="text-danger">N/A</span>
                            {% endif %}
                          </td>
                          <td class="text-center">
                            <button type="button" class="btn btn-info btn-sm details-order-btn rounded-pill mb-1" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="{{ order.id }}">
                              <i class="bx bx-show"></i> D√©tails
                            </button>
                            {% if order.status != 'delivered' %}
                            <button type="button" class="btn btn-success btn-sm confirm-order-btn rounded-pill mb-1" data-bs-toggle="modal" data-bs-target="#confirmOrderModal" data-order-id="{{ order.id }}" data-csrf-token="{{ csrf_token('confirm' ~ order.id) }}">
                              <i class="bx bx-check"></i> Confirmer
                            </button>
                            {% endif %}
                            <form method="post" action="{{ path('app_order_delete', {'id': order.id}) }}" style="display:inline-block;" class="d-inline">
                              <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ order.id) }}">
                              <button class="btn btn-danger btn-sm rounded-pill mb-1"><i class="bx bx-trash"></i> Supprimer</button>
                            </form>
                          </td>
                        </tr>
                      {% else %}
                        <tr>
                          <td colspan="6" class="text-center text-muted fst-italic">
                            Aucune commande trouv√©e.
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <div class="d-flex justify-content-center mt-4">
                  {% include 'pagination.html.twig' %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Modals and Toasts (identiques √† l'original, juste traduits) -->
        <div class="modal fade" id="confirmOrderModal" tabindex="-1" aria-labelledby="confirmOrderModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="confirmOrderModalLabel">Confirmer la commande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
              </div>
              <div class="modal-body">
                √ätes-vous s√ªr de vouloir confirmer cette commande ?
              </div>
              <div class="modal-footer">
                <form id="confirmOrderForm" method="post">
                  <input type="hidden" name="_token" id="confirmOrderToken" value="">
                  <input type="hidden" name="order_id" id="confirmOrderId" value="">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                  <button type="submit" class="btn btn-primary">Confirmer</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
              </div>
              <div class="modal-body">
                √ätes-vous s√ªr de vouloir supprimer cette commande ? Cette action est irr√©versible.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="confirmDeleteButton" class="btn btn-danger">Supprimer</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">D√©tails de la commande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
              </div>
              <div class="modal-body" id="orderDetailsModalBody">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Informations sur la commande</h6>
                    <table class="table table-sm">
                      <tr><th>ID :</th><td id="orderId"></td></tr>
                      <tr><th>Date :</th><td id="orderDate"></td></tr>
                      <tr><th>Statut :</th><td id="orderStatus"></td></tr>
                    </table>
                  </div>
                  <div class="col-md-6">
                    <h6>Informations sur le produit</h6>
                    <table class="table table-sm">
                      <tr><th>Nom :</th><td id="productName"></td></tr>
                      <tr><th>Prix :</th><td id="productPrice"></td></tr>
                      <tr><th>Quantit√© :</th><td id="productQuantity"></td></tr>
                      <tr><th>Prix total :</th><td id="totalPrice"></td></tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="toast-container position-fixed top-0 start-50 translate-middle-x mt-5 p-3" style="z-index: 1055;">
          <div id="successToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                Op√©ration r√©ussie.
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
            </div>
          </div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Recherche en temps r√©el
            document.getElementById('searchInput').addEventListener('keyup', function () {
              const value = this.value.toLowerCase();
              document.querySelectorAll('table tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(value) ? '' : 'none';
              });
            });
            // Handle Order Details
            const detailsButtons = document.querySelectorAll('.details-order-btn');
            detailsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    fetch(`/order/${orderId}/details`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('orderId').textContent = data.id;
                            document.getElementById('orderDate').textContent = new Date(data.date).toLocaleString();
                            document.getElementById('orderStatus').textContent = data.status;
                            document.getElementById('productName').textContent = data.product.name;
                            document.getElementById('productPrice').textContent = data.product.price + ' DT';
                            document.getElementById('productQuantity').textContent = data.quantity;
                            document.getElementById('totalPrice').textContent = (data.product.price * data.quantity) + ' DT';
                        })
                        .catch(error => {
                            console.error('Erreur :', error);
                            alert('Erreur lors du chargement des d√©tails de la commande');
                        });
                });
            });
            // Handle Order Confirmation
            const confirmButtons = document.querySelectorAll('.confirm-order-btn');
            confirmButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    const csrfToken = this.dataset.csrfToken;
                    document.getElementById('confirmOrderId').value = orderId;
                    document.getElementById('confirmOrderToken').value = csrfToken;
                });
            });
            // Handle Confirm Form Submission
            const confirmForm = document.getElementById('confirmOrderForm');
            confirmForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const orderId = document.getElementById('confirmOrderId').value;
                const csrfToken = document.getElementById('confirmOrderToken').value;
                fetch(`/order/${orderId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ _token: csrfToken })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const toast = new bootstrap.Toast(document.getElementById('successToast'));
                        toast.show();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmOrderModal'));
                        modal.hide();
                        setTimeout(() => { window.location.reload(); }, 1500);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur :', error);
                    alert('Erreur lors de la confirmation de la commande');
                });
            });
            // Handle Delete Confirmation
            let deleteFormToSubmit = null;
            const deleteForms = document.querySelectorAll('form[action*="delete"]');
            deleteForms.forEach(form => {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    deleteFormToSubmit = form;
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                    deleteModal.show();
                });
            });
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            confirmDeleteButton.addEventListener('click', function () {
                if (deleteFormToSubmit) {
                    const formData = new FormData(deleteFormToSubmit);
                    fetch(deleteFormToSubmit.action, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const toast = new bootstrap.Toast(document.getElementById('successToast'));
                            toast.show();
                            deleteFormToSubmit.closest('tr').remove();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur :', error);
                        alert('Une erreur est survenue lors de la suppression de la commande.');
                    });
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
                    deleteModal.hide();
                }
            });
        });
        </script>
        <footer class="content-footer footer bg-footer-theme">
          <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
            <div class="mb-2 mb-md-0">
              ¬© <script>document.write(new Date().getFullYear());</script>
              R√©alis√© avec ‚ù§Ô∏è par Votre Soci√©t√©
            </div>
          </div>
        </footer>
      </div>
    </div>
  </div>
  <script src="{{ asset('BackOffice/assets/vendor/libs/jquery/jquery.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/vendor/libs/popper/popper.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/vendor/js/bootstrap.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/vendor/js/menu.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/js/main.js') }}"></script>
  <script src="{{ asset('BackOffice/assets/js/dashboards-analytics.js') }}"></script>
</body>
</html>
